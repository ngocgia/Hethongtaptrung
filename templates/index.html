<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Điều Phối Quản Trị IGATE</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="header-left">
                <div class="header-text">
                    <h1>HỆ THỐNG ĐIỀU PHỐI QUẢN TRỊ IGATE</h1>
                    <p class="subtitle">Vì nền hành chính phục vụ</p>
                </div>
            </div>
            <div class="header-right">
                <div class="user-profile">
                    <div class="avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <span class="user-name">{{ user.full_name or user.username }}</span>
                        <span class="user-org">Đang đăng nhập</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </div>
                    <div class="logout-btn">
                        <a href="{{ url_for('logout') }}" title="Đăng xuất">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="/" class="nav-item active">
                <i class="fas fa-home"></i>
                TRANG CHỦ
            </a>
            <a href="#" onclick="showSearchSection()" class="nav-item">
                <i class="fas fa-search"></i>
                TRA CỨU TÀI KHOẢN
            </a>
            <a href="#" onclick="showImportSection()" class="nav-item">
                <i class="fas fa-file-excel"></i>
                TẠO TÀI KHOẢN
            </a>
            <a href="#" onclick="syncTokens()" class="nav-item">
                <i class="fas fa-sync"></i>
                ĐỒNG BỘ TOKEN
            </a>
            <a href="#" onclick="viewTokens()" class="nav-item">
                <i class="fas fa-key"></i>
                XEM TOKEN
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- Search Section -->
        <section class="search-section" id="searchSection" style="display: none;">
            <div class="search-container">
                <h2>Tra cứu tài khoản trên các Bộ</h2>

                <div class="search-form">
                    <div class="search-input-group">
                        <input type="text" id="searchKeyword" placeholder="Nhập tên tài khoản, CMND/CCCD, email, số điện thoại..." autofocus>
                        <button type="button" class="btn-search" onclick="searchAccount()">
                            <i class="fas fa-search"></i>
                            Tra cứu
                        </button>
                    </div>
                </div>

                <div id="searchResults" class="search-results"></div>
            </div>
        </section>

        <!-- Import Section -->
        <section class="import-section" id="importSection" style="display: none;">
            <div class="import-container">
                <h2>Tạo tài khoản cán bộ từ Excel</h2>

                <div class="import-form" id="importForm">
                    <div class="import-step">
                        <h3><i class="fas fa-download"></i> Bước 1: Tải mẫu file Excel</h3>
                        <p>Tải xuống file mẫu để biết định dạng các cột bắt buộc:</p>
                        <button type="button" class="btn-download" onclick="downloadTemplate()">
                            <i class="fas fa-file-excel"></i>
                            Tải mẫu Excel
                        </button>
                    </div>

                    <div class="import-step">
                        <h3><i class="fas fa-edit"></i> Bước 2: Nhập thông tin vào file Excel</h3>
                        <p>Điền thông tin cán bộ vào file Excel theo đúng định dạng. Các cột bắt buộc:</p>
                        <ul class="required-fields">
                            <li><code>fullname</code> - Họ tên</li>
                            <li><code>phoneNumber</code> - Số điện thoại</li>
                            <li><code>email</code> - Email</li>
                            <li><code>username</code> - Tên đăng nhập (thường là CMND/CCCD)</li>
                            <li><code>password</code> - Mật khẩu</li>
                        </ul>
                        <p>Các cột tùy chọn: <code>agencyParent</code>, <code>agencyDepartment</code>, <code>position</code></p>
                    </div>

                    <div class="import-step">
                        <h3><i class="fas fa-check-square"></i> Bước 3: Chọn các Bộ cần tạo tài khoản</h3>
                        <div class="ministry-selector">
                            <label class="select-all">
                                <input type="checkbox" id="selectAllMinistries" onchange="toggleAllMinistries()">
                                <span>Chọn tất cả</span>
                            </label>
                            <div class="ministry-checkboxes" id="ministryCheckboxes">
                                {% for ministry in ministries %}
                                <label class="ministry-checkbox">
                                    <input type="checkbox" class="ministry-select" value="{{ ministry.id }}">
                                    <span>{{ ministry.name }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="import-step">
                        <h3><i class="fas fa-upload"></i> Bước 4: Upload file Excel</h3>
                        <div class="file-upload">
                            <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect(this)">
                            <button type="button" class="btn-upload" onclick="document.getElementById('excelFile').click()">
                                <i class="fas fa-folder-open"></i>
                                Chọn file Excel
                            </button>
                            <span id="selectedFileName" class="file-name">Chưa chọn file</span>
                        </div>
                    </div>

                    <div class="import-step">
                        <h3><i class="fas fa-play"></i> Bước 5: Thực hiện tạo tài khoản</h3>
                        <button type="button" class="btn-import" onclick="importAccounts()" id="btnImport" disabled>
                            <i class="fas fa-cogs"></i>
                            Tạo tài khoản
                        </button>
                    </div>
                </div>

                <div id="importResults" class="import-results"></div>
            </div>
        </section>

        <section class="ministries-section">
            <div class="ministries-container">
                <h3>Truy cập vào hệ thống quản trị các Bộ</h3>
                <div class="ministries-grid" id="ministriesGrid">
                    {% for ministry in ministries %}
                    <div class="ministry-card" data-id="{{ ministry.id }}">
                        <a href="{{ ministry.url }}" target="_blank" rel="noopener noreferrer">
                            <div class="ministry-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <h4>{{ ministry.name }}</h4>
                            <span class="token-status" id="status-{{ ministry.id }}">
                                <i class="fas fa-circle-notch fa-spin"></i>
                            </span>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <p>&copy; 2026 GiaVDN.KTM</p>
        </div>
    </footer>

    <!-- Token Modal -->
    <div id="tokenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Danh sách Token</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="tokenList">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Đang tải...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load token status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkTokenStatus();
        });

        function showSearchSection() {
            const searchSection = document.getElementById('searchSection');
            searchSection.style.display = searchSection.style.display === 'none' ? 'block' : 'none';
            if (searchSection.style.display === 'block') {
                document.getElementById('searchKeyword').focus();
            }
        }

        function showImportSection() {
            const importSection = document.getElementById('importSection');
            importSection.style.display = importSection.style.display === 'none' ? 'block' : 'none';
        }

        function toggleAllMinistries() {
            const selectAll = document.getElementById('selectAllMinistries').checked;
            const checkboxes = document.querySelectorAll('.ministry-select');
            checkboxes.forEach(cb => cb.checked = selectAll);
            checkImportForm();
        }

        function handleFileSelect(input) {
            const fileName = input.files[0]?.name || 'Chưa chọn file';
            document.getElementById('selectedFileName').textContent = fileName;
            checkImportForm();
        }

        function checkImportForm() {
            const fileSelected = document.getElementById('excelFile').files.length > 0;
            const anyMinistrySelected = document.querySelectorAll('.ministry-select:checked').length > 0;
            document.getElementById('btnImport').disabled = !(fileSelected && anyMinistrySelected);
        }

        // Thêm event listener cho các checkbox bộ
        document.addEventListener('DOMContentLoaded', function() {
            checkTokenStatus();

            document.querySelectorAll('.ministry-select').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const allChecked = document.querySelectorAll('.ministry-select:checked').length === document.querySelectorAll('.ministry-select').length;
                    document.getElementById('selectAllMinistries').checked = allChecked;
                    checkImportForm();
                });
            });
        });

        function downloadTemplate() {
            const template = [
                ['fullname', 'phoneNumber', 'email', 'username', 'password', 'agencyParent', 'agencyDepartment', 'position'],
                ['Nguyễn Văn A', '0123456789', 'nguyenvana@example.com', '001234567890', 'Password@123', 'Bộ Giáo dục', 'Vụ Giáo dục Đại học', 'Chuyên viên'],
                ['Trần Thị B', '0987654321', 'tranthib@example.com', '001987654321', 'Password@456', 'Bộ Y tế', 'Cục Quản lý Dược', 'Chuyên viên']
            ];

            let csvContent = template.map(row => row.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'mau_tai_khoan_can_bo.csv';
            link.click();
        }

        async function importAccounts() {
            const fileInput = document.getElementById('excelFile');
            const selectedMinistries = Array.from(document.querySelectorAll('.ministry-select:checked')).map(cb => cb.value);

            if (fileInput.files.length === 0) {
                alert('Vui lòng chọn file Excel!');
                return;
            }

            if (selectedMinistries.length === 0) {
                alert('Vui lòng chọn ít nhất một Bộ!');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('ministries', selectedMinistries.join(','));

            const resultsDiv = document.getElementById('importResults');
            const btnImport = document.getElementById('btnImport');

            btnImport.disabled = true;
            btnImport.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
            resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Đang tạo tài khoản, vui lòng đợi...</div>';

            try {
                const response = await fetch('/import-accounts', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error-message">${data.error}</div>`;
                    return;
                }

                displayImportResults(data);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-message">Lỗi khi import: ${error.message}</div>`;
            } finally {
                btnImport.disabled = false;
                btnImport.innerHTML = '<i class="fas fa-cogs"></i> Tạo tài khoản';
            }
        }

        function displayImportResults(data) {
            const resultsDiv = document.getElementById('importResults');

            let html = `<div class="import-summary">`;
            html += `<h3>Kết quả tạo tài khoản</h3>`;
            html += `<div class="summary-stats">`;
            html += `<span><i class="fas fa-users"></i> Tổng số tài khoản: <strong>${data.summary.total_accounts}</strong></span> | `;
            html += `<span><i class="fas fa-tasks"></i> Tổng số thao tác: <strong>${data.summary.total_operations}</strong></span> | `;
            html += `<span style="color: green;"><i class="fas fa-check-circle"></i> Thành công: <strong>${data.summary.success_count}</strong></span> | `;
            html += `<span style="color: red;"><i class="fas fa-times-circle"></i> Lỗi: <strong>${data.summary.error_count}</strong></span>`;
            html += `</div>`;
            html += `</div>`;

            html += '<div class="import-details">';

            data.results.forEach((result, index) => {
                html += `
                    <div class="account-result-item">
                        <div class="account-result-header">
                            <h4>Dòng ${result.row}: ${result.account.fullname}</h4>
                            <span class="account-info">Username: ${result.account.username}</span>
                        </div>
                        <div class="ministry-results">
                `;

                result.ministries.forEach(m => {
                    let statusClass = '';
                    let icon = '';

                    if (m.status === 'success') {
                        statusClass = 'success';
                        icon = '<i class="fas fa-check-circle"></i>';
                    } else if (m.status === 'no_token') {
                        statusClass = 'no-token';
                        icon = '<i class="fas fa-key"></i>';
                    } else if (m.status === 'token_expired') {
                        statusClass = 'token-expired';
                        icon = '<i class="fas fa-clock"></i>';
                    } else {
                        statusClass = 'error';
                        icon = '<i class="fas fa-times-circle"></i>';
                    }

                    html += `
                        <div class="ministry-result ${statusClass}">
                            <span class="ministry-name">${m.ministry_name}</span>
                            <span class="ministry-status">${icon} ${m.message}</span>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        async function searchAccount() {
            console.log('searchAccount called');
            const keyword = document.getElementById('searchKeyword').value.trim();
            const resultsDiv = document.getElementById('searchResults');

            console.log('Keyword:', keyword);

            if (!keyword) {
                alert('Vui lòng nhập từ khóa tìm kiếm!');
                return;
            }

            resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Đang tra cứu trên tất cả các Bộ...</div>';

            try {
                const formData = new FormData();
                formData.append('keyword', keyword);

                console.log('Sending request to /lookup-account');

                const response = await fetch('/lookup-account', {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);

                const data = await response.json();

                console.log('Response data:', data);

                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error-message">${data.error}</div>`;
                    return;
                }

                displayAllMinistriesResults(data.results, keyword);
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = `<div class="error-message">Lỗi khi tra cứu: ${error.message}</div>`;
            }
        }

        function displayAllMinistriesResults(results, keyword) {
            const resultsDiv = document.getElementById('searchResults');

            // Thống kê
            let foundCount = 0;
            let notFoundCount = 0;
            let noTokenCount = 0;
            let tokenExpiredCount = 0;
            let errorCount = 0;

            results.forEach(r => {
                if (r.found) foundCount++;
                else if (r.status === 'success') notFoundCount++;
                else if (r.status === 'no_token') noTokenCount++;
                else if (r.status === 'token_expired') tokenExpiredCount++;
                else errorCount++;
            });

            let html = `<div class="search-summary">`;
            html += `<h3>Kết quả tra cứu: "${keyword}"</h3>`;
            html += `<div class="summary-stats">`;
            html += `<span style="color: green;"><i class="fas fa-check-circle"></i> Tìm thấy: <strong>${foundCount}</strong></span> | `;
            html += `<span style="color: orange;"><i class="fas fa-times-circle"></i> Không tìm thấy: <strong>${notFoundCount}</strong></span> | `;
            html += `<span style="color: red;"><i class="fas fa-exclamation-triangle"></i> Lỗi: <strong>${errorCount}</strong></span> | `;
            html += `<span style="color: gray;"><i class="fas fa-key"></i> Chưa có token: <strong>${noTokenCount}</strong></span> | `;
            html += `<span style="color: purple;"><i class="fas fa-clock"></i> Token hết hạn: <strong>${tokenExpiredCount}</strong></span>`;
            html += `</div>`;
            html += `</div>`;

            html += '<div class="results-grid">';

            results.forEach(result => {
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';

                if (result.found) {
                    statusClass = 'found';
                    statusIcon = '<i class="fas fa-check-circle"></i>';
                    statusText = `Tìm thấy ${result.accounts.length} tài khoản`;

                    html += `
                        <div class="result-card ${statusClass}">
                            <div class="result-header">
                                <h4>${result.ministry_name}</h4>
                                <span class="result-status ${statusClass}">${statusIcon} ${statusText}</span>
                            </div>
                            <div class="result-body">
                    `;

                    result.accounts.forEach(account => {
                        html += `
                            <div class="account-item">
                                <p><i class="fas fa-user"></i> <strong>Họ tên:</strong> ${account.fullname || 'N/A'}</p>
                                <p><i class="fas fa-id-card"></i> <strong>Username:</strong> ${account.account.username[0].value || 'N/A'}</p>
                                ${account.email[0].value ? `<p><i class="fas fa-envelope"></i> <strong>Email:</strong> ${account.email[0].value}</p>` : ''}
                                ${account.phoneNumber[0].value ? `<p><i class="fas fa-phone"></i> <strong>Điện thoại:</strong> ${account.phoneNumber[0].value}</p>` : ''}
                                ${account.account.username[0].value ? `<p><i class="fas fa-fingerprint"></i> <strong>CMND/CCCD:</strong> ${account.identity?.number}</p>` : ''}
                                ${account.experience[0].agency.name ? `<p><i class="fas fa-building"></i> <strong>Đơn vị:</strong> ${account.experience[0].agency.parent.name}</p>` : ''}
                                ${account.type !== undefined ? `<p><i class="fas fa-power-off"></i> <strong>Kiểu:</strong> ${account.type === 3 ? '<span style="color: green;">Cán bộ</span>' : '<span style="color: green;">Công dân</span>'}</p>` : ''}
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                } else if (result.status === 'success') {
                    statusClass = 'not-found';
                    statusIcon = '<i class="fas fa-times-circle"></i>';
                    statusText = 'Không tìm thấy tài khoản';

                    html += `
                        <div class="result-card ${statusClass}">
                            <div class="result-header">
                                <h4>${result.ministry_name}</h4>
                                <span class="result-status ${statusClass}">${statusIcon} ${statusText}</span>
                            </div>
                            <div class="result-body">
                                <p class="not-found-message">Không tìm thấy tài khoản với từ khóa "${keyword}"</p>
                            </div>
                        </div>
                    `;
                } else if (result.status === 'no_token') {
                    statusClass = 'no-token';
                    statusIcon = '<i class="fas fa-key"></i>';
                    statusText = 'Chưa đồng bộ token';

                    html += `
                        <div class="result-card ${statusClass}">
                            <div class="result-header">
                                <h4>${result.ministry_name}</h4>
                                <span class="result-status ${statusClass}">${statusIcon} ${statusText}</span>
                            </div>
                            <div class="result-body">
                                <p class="warning-message">Bạn cần đồng bộ token cho Bộ này trước khi tra cứu.</p>
                            </div>
                        </div>
                    `;
                } else if (result.status === 'token_expired') {
                    statusClass = 'token-expired';
                    statusIcon = '<i class="fas fa-clock"></i>';
                    statusText = 'Token đã hết hạn';

                    html += `
                        <div class="result-card ${statusClass}">
                            <div class="result-header">
                                <h4>${result.ministry_name}</h4>
                                <span class="result-status ${statusClass}">${statusIcon} ${statusText}</span>
                            </div>
                            <div class="result-body">
                                <p class="warning-message">Token đã hết hạn. Vui lòng đồng bộ lại token.</p>
                            </div>
                        </div>
                    `;
                } else {
                    statusClass = 'error';
                    statusIcon = '<i class="fas fa-exclamation-triangle"></i>';
                    statusText = 'Lỗi';

                    html += `
                        <div class="result-card ${statusClass}">
                            <div class="result-header">
                                <h4>${result.ministry_name}</h4>
                                <span class="result-status ${statusClass}">${statusIcon} ${statusText}</span>
                            </div>
                            <div class="result-body">
                                <p class="error-message">${result.message}</p>
                            </div>
                        </div>
                    `;
                }
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function displaySearchResults(results, keyword) {
            const resultsDiv = document.getElementById('searchResults');

            let foundCount = 0;
            let notFoundCount = 0;
            let errorCount = 0;

            results.forEach(r => {
                if (r.found) foundCount++;
                else if (r.status === 'success') notFoundCount++;
                else errorCount++;
            });

            let html = `<div class="search-summary">`;
            html += `<h3>Kết quả tra cứu: "${keyword}"</h3>`;
            html += `<p>Tìm thấy: <strong style="color: green;">${foundCount}</strong> | `;
            html += `Không tìm thấy: <strong style="color: orange;">${notFoundCount}</strong> | `;
            html += `Lỗi: <strong style="color: red;">${errorCount}</strong></p>`;
            html += `</div>`;

            html += '<div class="results-grid">';

            results.forEach(result => {
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';

                if (result.found) {
                    statusClass = 'found';
                    statusIcon = '<i class="fas fa-check-circle"></i>';
                    statusText = 'Đã có tài khoản';

                    const account = result.account;
                    html += `
                        <div class="result-card ${statusClass}">
                            <div class="result-header">
                                <h4>${result.ministry_name}</h4>
                                <span class="result-status ${statusClass}">${statusIcon} ${statusText}</span>
                            </div>
                            <div class="result-body">
                                <p><i class="fas fa-user"></i> <strong>Họ tên:</strong> ${account.fullname || 'N/A'}</p>
                                <p><i class="fas fa-id-card"></i> <strong>Username:</strong> ${account.username || 'N/A'}</p>
                                ${account.email ? `<p><i class="fas fa-envelope"></i> <strong>Email:</strong> ${account.email}</p>` : ''}
                                ${account.phone ? `<p><i class="fas fa-phone"></i> <strong>Điện thoại:</strong> ${account.phone}</p>` : ''}
                            </div>
                        </div>
                    `;
                } else if (result.status === 'success') {
                    statusClass = 'not-found';
                    statusIcon = '<i class="fas fa-times-circle"></i>';
                    statusText = 'Không tìm thấy';

                    html += `
                        <div class="result-card ${statusClass}">
                            <div class="result-header">
                                <h4>${result.ministry_name}</h4>
                                <span class="result-status ${statusClass}">${statusIcon} ${statusText}</span>
                            </div>
                            <div class="result-body">
                                <p class="not-found-message">Không tìm thấy tài khoản với từ khóa "${keyword}"</p>
                            </div>
                        </div>
                    `;
                } else {
                    statusClass = 'error';
                    statusIcon = '<i class="fas fa-exclamation-triangle"></i>';
                    statusText = result.message || 'Lỗi';

                    html += `
                        <div class="result-card ${statusClass}">
                            <div class="result-header">
                                <h4>${result.ministry_name}</h4>
                                <span class="result-status ${statusClass}">${statusIcon} ${statusText}</span>
                            </div>
                        </div>
                    `;
                }
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        async function checkTokenStatus() {
            try {
                const response = await fetch('/tokens');
                const data = await response.json();

                data.tokens.forEach(token => {
                    const statusEl = document.getElementById(`status-${token.ministry_id}`);
                    if (statusEl) {
                        if (token.has_token) {
                            const expiresAt = new Date(token.expires_at);
                            const now = new Date();
                            const isExpired = expiresAt < now;

                            if (isExpired) {
                                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: orange;"></i> Hết hạn';
                            } else {
                                statusEl.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> Đã có token';
                            }
                        } else {
                            statusEl.innerHTML = '<i class="fas fa-times-circle" style="color: red;"></i> Chưa đồng bộ';
                        }
                    }
                });
            } catch (error) {
                console.error('Error checking token status:', error);
            }
        }

        async function syncTokens() {
            if (!confirm('Bạn có muốn đồng bộ token cho tất cả các Bộ?')) {
                return;
            }

            const btn = event.target;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ĐANG ĐỒNG BỘ...';
            btn.disabled = true;

            try {
                const response = await fetch('/sync-tokens', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                let successCount = 0;
                let failCount = 0;

                data.results.forEach(result => {
                    if (result.status === 'success') {
                        successCount++;
                    } else {
                        failCount++;
                    }
                });

                alert(`Đồng bộ hoàn tất!\n\nThành công: ${successCount}\nThất bại: ${failCount}`);

                checkTokenStatus();
            } catch (error) {
                alert('Lỗi khi đồng bộ token: ' + error.message);
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        async function viewTokens() {
            document.getElementById('tokenModal').style.display = 'block';

            try {
                const response = await fetch('/tokens');
                const data = await response.json();

                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #f5f5f5;">';
                html += '<th style="padding: 10px; border: 1px solid #ddd;">STT</th>';
                html += '<th style="padding: 10px; border: 1px solid #ddd;">Bộ</th>';
                html += '<th style="padding: 10px; border: 1px solid #ddd;">Trạng thái</th>';
                html += '<th style="padding: 10px; border: 1px solid #ddd;">Hết hạn</th>';
                html += '</tr></thead><tbody>';

                data.tokens.forEach((token, index) => {
                    html += '<tr>';
                    html += `<td style="padding: 10px; border: 1px solid #ddd;">${index + 1}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #ddd;">${token.ministry_name}</td>`;

                    if (token.has_token) {
                        html += '<td style="padding: 10px; border: 1px solid #ddd; color: green;">✓ Có token</td>';
                        const expiresAt = new Date(token.expires_at);
                        html += `<td style="padding: 10px; border: 1px solid #ddd;">${expiresAt.toLocaleString('vi-VN')}</td>`;
                    } else {
                        html += '<td style="padding: 10px; border: 1px solid #ddd; color: red;">✗ Chưa có</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">-</td>';
                    }

                    html += '</tr>';
                });

                html += '</tbody></table>';
                document.getElementById('tokenList').innerHTML = html;
            } catch (error) {
                document.getElementById('tokenList').innerHTML = '<p style="color: red;">Lỗi tải danh sách token</p>';
            }
        }

        function closeModal() {
            document.getElementById('tokenModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('tokenModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
